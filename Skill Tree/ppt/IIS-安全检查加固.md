## Win下IIS搭建aspcms和安全加固检查

## 搭建aspcms网站

### 安装IIS、ASP、Access/Sql Server

#### 为什么安装IIS，搭建aspcms，

> 因为现在很多的企业网站，学校，都是用的是IIS+asp架构。
> 通过自己搭建网站，可以更直接的理解网站可能存在的问题。

#### IIS  ASP  access/Sql Server

* 现在的网站结构，访问一个网站的流程。
  客户端把请求发给web服务器软件，如果它不能处理，就交给后台的web应用，web应用处理之后返回给，web服务器软件就会把数据返回给客户端。在web应用处理请求时，如果需要处理数据，就会打开数据库修改数据库中的数据。

* IIS是什么，ASP是什么，ACCESS是什么
  IIS是来解析网站的请求，并且给客户端返回数据。是web服务器软件。
  ASP是服务器语言，它在后台编写web应用，处理各种请求
  ACCESS是数据库，用来处理数据信息

### 安装Windows server2008

新建虚拟机，安装windows server 2008。

![1][1]

![2][2]

![3][3]

* 在安装时选择专业版安装


#### 为虚拟机安装vmware tools

* tools是方便操作虚拟机的软件
* 安装Vmware Tools在软件的虚拟机选项中，点开安装Vmware Tools选项。
    在系统中会打开安装程序。

![4][4]

> vmware tools功能是为了方便在虚拟机和实体机之间进行数据交互
> 在安装之前，尝试复制文件进入虚拟机，安装之后再次复制内容进入虚拟机。
> 尝试使用unity模式操作window虚拟机


* 安装Vmware Tools工具，方便控制系统。
    安装之后建立快照



#### 步骤1：安装IIS服务器

> 打开服务器管理器，在里面新建角色。

* windows server的服务器管理器，可以快捷安装管理系统软件
    ‘角色’可以来搭建web，ftp，dhcp等服务
    ‘功能’使用来添加一些基础的系统软件
    ‘诊断’可以查看系统日志信息
    ‘配置’添加任务
    ‘存储’查看磁盘信息


> 建立IIS角色，选择web服务器。

![5][5]

![6][6]


#### 步骤2：设置IIS的ASP支持。
> 在建立IIS角色时，选择ASP的功能支持。
>
> asp是根据.net框架来开发的服务器语言，因此，需要安装.net framework
>
> 在功能的模块中，选择安装.net framework，
>
> 同时，安装下载的.net framework4.0

![7][7]



* 在安装完成IIS程序之后，建立快照

#### 步骤3：放置aspcms网站。

> 页面介绍:
>
> 打开的窗口中，`wim-****`是web服务的名称，通过它可以重启删除，管理IIS服务
>
> asp.net设置是一些个性化定制的.net配置
>
> IIS选项是来配置IIS服务器和网站的，可以添加修改配置网站，
>
> 在安装完成IIS之后，在角色管理处，打开internet信息服务，
>
> 管理我们默认的网站。

![8][8]

> 先删除默认的网站，建立自己的网站。
>
> 为了自定义设置的网站信息

![9][9]

> 删除默认的应用程序池，它里面是网站的配置信息。
>
> 删除默认的。

![10][10]

> 在网站上右击添加网站

![11][11]

> 如图添加网站信息
>
> 首先需要设置网站的名称，
>
> 设置网站的应用程序池，网站的使用的.net框架的配置信息
>
> 选择网站的默认路径
>
> 设置网站端口。

![12][12]

> 点击应用程序池--选择刚才创建的网站名称--双击更改程序
>
> 修改.net框架的信息
>
> 使用我们自己安装的.net4.0来运行我们的web网站

![13][13]

![14][14]

> 选择网站--右击asp--选择打开功能
>
> 在这里有很多选项，可以管理网站，启动，暂停，删除。
>
> 还可以设置网站目录的权限，和linux一样，windows也用有权限控制，只有给网站目录设置权限之后，才可以正确的运行网站。
>
> 主要讲解几个选项：
>
> 目录浏览，可以通过浏览器遍历目录
>
> 日志，管理网站的日志，更新，删除，存储位置等
>
> 错误页，是显示网站的404错误信息，讲解什么是404，也可以选择讲解500，300等网站状态码

![15][15]

> 启用父路径--应用

![16][16]

> 选择默认文档--添加--index.asp
>
> 设置一个网站，进入后打开的第一个页面。

![17][17]

![18][18]

> 选择应用池--设置应用程序池--启用32位应用程序
>
> 这个选项是应用程序池的配置，因为我们安装的是64位的操作系统，可以修改配置，让.net框架支持32位的web程序。

![19][19]

* 在配置完成IIS程序之后，建立快照



#### 步骤4：使用access运行网站


由于windows server 自带access数据库，
直接修改配置，完成网站搭建。


> 修改aspcms的配置文件，连接数据库。
>
> aspcms是一个开源的强大的asp网站，它支持access数据库和sqlserver数据库
>
> 我们使用不同的方式来运行这个网站。
>
> 通过查看系统中的文件，修改配置，使用access数据库。
>
> access数据库是office中带有的轻量级数据库，它的数据存储在一个单独的文件中，aspcms是在data目录下`#5Dp8Gh.asp`文件。aspcms的数据都在此文件中，因此不需要去修改数据库。
>
> 和昨天搭建wordpress不一样，不需要登入数据库，导入数据。
>
> 讲解为什么需要数据库，因为把数据和网站分离，方便移植，也是web2.0时代的大趋势。
>
> 

#### 步骤5：启动网站

> 网站可以正常运营

![20][20]

* 在安装完成aspcms程序之后，建立快照



#### 步骤5:使用Sql server运行网站。

> Sql Server数据库是一个强大的数据库，它运行在windows上，有图形界面，数据方便操作。
>
> 很多网站使用sqlserver数据库。
>
> 打开Sql Server的安装程序。


![21][21]



> 选择所有的Sql Server服务，
> 安装所有功能

![22][22]

> 设置混合登录模式
> windows直接登录和通过账户密码登录

![23][23]

> 完成安装

![24][24]

* 在安装完成Sql Server程序之后，建立快照



> 导入SqlServer数据库
> 将aspcms的数据文件，导入到SqlServer数据库中
>
> 完成Sql Server安装之后，打开Sql Server的管理工具，使用windows验证登录数据库。

![25][25]

> sql server 数据库有两种登录方式，一种是windows身份验证，另外一种是使用帐号密码登录数据库。
>
> 帐号密码是我们安装时设置的。
>
> windows身份认证是利用windows系统自带的功能，来登入数据库，方便快捷安全，但是只有本地主机可以登入。

![26][26]

> 新建数据库aspcms，选择任务，导入数据，选择access数据库，选择数据库文件，导入到数据库中
>
> 之前通过access数据库成功搭建网站，由于access数据库的特殊性，不需要修改数据库，但是sqlserver数据库需要修改数据库，导入数据，和mysql一样。
>
> 通过自带的功能，导入access数据库。

![27][27]


> ![28][28]
> ![29][29]



> 修改aspcms的配置文件，连接数据库。
>
> 在这里要输入sqlserver数据库的地址，账户和密码，和mysql一样。

```asp
Const dbType=1  '数据库类型（0为access；1为sqlserver）
Const databaseServer="127.0.0.1"  'sqlserver数据库地址
Const databaseName="aspcms"  'sqlserver数据库名称
Const databaseUser="sa"  'sqlserver数据库账号
Const databasepwd=""  'sqlserver数据库密码
```

#### 步骤6：启动网站

> 网站可以正常运营

![30][30]



## Windows下进行安全检查

* 在安装linux系统的时候进行了简单地系统安全加固，来保护我们的系统。
* windows下可以通过安全检查来加固我们的系统。
* windows的安全检查主要有：
  补丁检查
  密码策略检查
  账户策略检查
  后门检查
* 其中补丁和后门是最主要的检查位置。

#### 步骤1：Service Packs和Hotfixs安装情况

> 运行cmd打开命令提示符窗口,再输入systeminfo查看目前补丁信息
* 重点:
* 主机安装补丁，windows系统中有很多的bug和漏洞，微软通过安装补丁的方式来修复这些漏洞。
* 通过安装补丁可以加强系统的安全性。


![31][31]

#### 步骤2:审计和帐号策略

> 点击开始->设置->控制面板，然后双击管理工具，最后双击本地安全策略，开始进行检查`

![32][32]

```
密码策略：密码必须符合复杂性要求，是否启用
密码策略：密码长度最小值（8）
密码策略：密码最长使用期限（90天）
密码策略：密码最短使用期限（1天）
密码策略：强制密码历史（24）
密码策略：用可还原的加密来储存密码（禁用）
```

![33][33]

```
帐户锁定策略：复位帐户锁定计数器（15分钟之后）
帐户锁定策略：帐户锁定阀值（3次无效登录） 
```

![34][34]

```
安全选项：帐户：来宾状态（已禁用）
```

![35][35]

```
审核策略：审核策略更改（成功和失败）
审核策略：审核登录事件（成功和失败）
审核策略：审核对象访问（失败） 
审核策略：审核目录服务访问（未定义）
审核策略：审核特权使用（失败）
审核策略：审核帐户登录事件（成功和失败）
审核策略：审核帐户管理（成功和失败）
```

#### 步骤3：安全设置

> 点击开始->设置->控制面板，然后双击管理工具，最后双击本地安全策略，选择安全选项进行检查

![36][36]

```
Microsoft 网络服务器：当登录时间用完时自动注销用户（启用）
Microsoft 网络服务器：在挂起会话之前所需的空闲时间（小于等于30分钟）
Microsoft 网络客户端：发送未加密的密码到第三方SMB服务器:（禁用） 
故障恢复控制台:允许对所有驱动器和文件夹进行软盘复制和访问（禁用）
故障恢复控制台:允许自动系统管理级登录（禁用）  
故障恢复控制台:允许自动系统管理级登录（禁用）  
关机：清除虚拟内存页面文件（启用） 
关机：允许系统在未登录前关机（禁用）   
交互式登录：不显示上次的用户名（启用）   
交互式登录：不需要按Ctrl+Alt+Del（禁用）   
交互式登录：可被缓存的前次登录个数（在域控制器不可用的情况下）（0）   
帐户：重命名系统管理员账户（除了Administrator 的其它名字）   
网络访问：不允许SAM帐户和共享的匿名枚举（启用）   
网络访问：不允许为网络身份验证储存凭证或 .NET passports(启用）   
审核：如果无法记录安全审核则立即关闭系统 （启用）   
审核：对全局系统对象的访问进行审核（启用）   
审核：对备份和还原权限的使用进行审核（启用）   
关闭系统: 只有Administrators组  
通过终端服务拒绝登陆：加入Guests、User组   
通过终端服务允许登陆：只加入Administrators组     
```

#### 步骤4：禁止不必要服务

> 操作：点击开始->设置->控制面板，然后双击管理工具，最后双击服务，开始进行检查

![37][37]

```
Computer Browser – 禁止  
Internet Connection Sharing – 禁止 
Routing and Remote Access – 禁止   
Simple Mail Trasfer Protocol(SMTP) – 禁止 
Simple Network Management Protocol(SNMP) Service – 禁止   
Simple Network Management Protocol(SNMP) Trap – 禁止   
Telnet – 禁止   
```



####步骤5：后门查找

* 重点：
* 查看系统中异常的端口，一般黑客攻击主机后，可能会留下后门，通过开放一些端口来控制主机。

`netstat -an`

![38][38]


* 查看一下有没有异常端口开放，或者未知服务端口


`net start`

> 最后我们启动服务，命令如下：
* 重点：
* 通过查看已经启动的服务，查看是否有异常的服务运行


![39][39]

* 查看一下有没有异常服务启动

`net user`

* 查看系统中有没有不认识的账户，以免被黑客留下后门。

![40][40]


* 查看有没有异常账号


* 在修改完成Windows服务后，建立快照。


##  实验

## 实验环境

    windows server 2008 r2
    sql server 2008 r2完整安装程序
    apapche任意版本安装程序
    php5安装程序
    mysql任意版本安装程序

###  实验目的

	学会搭建不同的web环境，为以后测试打基础。

### 实验一

    自己搭建IIS+ASP+sql server的网站。

### 实验二

    在windows上搭建apache+php+mysql



[1]:./image/1.png
[2]:./image/2.png
[3]:./image/3.png
[4]:./image/4.png
[5]:./image/5.png
[6]:./image/6.png
[7]:./image/7.png
[8]:./image/8.jpg
[9]:./image/9.jpg
[10]:./image/10.jpg
[11]:./image/11.jpg
[12]:./image/12.jpg
[13]:./image/13.jpg
[14]:./image/14.jpg
[15]:./image/15.jpg
[16]:./image/16.jpg
[17]:./image/17.jpg
[18]:./image/18.jpg
[19]:./image/19.jpg
[20]:./image/20.png
[21]:./image/21.png
[22]:./image/22.png
[23]:./image/23.png
[24]:./image/24.png
[25]:./image/25.png
[26]:./image/26.png
[27]:./image/27.png
[28]:./image/28.png
[29]:./image/29.png
[30]:./image/30.png
[31]:./image/31.jpg
[32]:./image/32.jpg
[33]:./image/33.jpg
[34]:./image/34.jpg
[35]:./image/35.jpg
[36]:./image/36.jpg
[37]:./image/37.jpg
[38]:./image/38.jpg
[39]:./image/39.jpg
[40]:./image/40.jpg
